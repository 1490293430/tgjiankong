server {
    listen 80;
    server_name _;
    root /usr/share/nginx/html;
    index index.html;
    
    # å¢åŠ è¯·æ±‚ä½“å¤§å°é™åˆ¶
    client_max_body_size 10M;
    
    # å‰ç«¯é™æ€æ–‡ä»¶
    location / {
        try_files $uri $uri/ /index.html;
    }

    # Favicon å›¾æ ‡ï¼ˆä¼˜å…ˆå¤„ç†ï¼‰
    location = /favicon.ico {
        try_files /favicon.ico =404;
        expires 30d;
        add_header Cache-Control "public, immutable";
        add_header Content-Type "image/x-icon";
        access_log off;
        log_not_found off;
    }
    
    # ç¼“å­˜é™æ€èµ„æº
    location ~* \.(jpg|jpeg|png|gif|ico|css|js)$ {
        try_files $uri =404;
        expires 7d;
        add_header Cache-Control "public, immutable";
    }
    
    # SSE äº‹ä»¶æµä¸“ç”¨é…ç½®ï¼ˆå¿…é¡»åœ¨é€šç”¨ API é…ç½®ä¹‹å‰ï¼‰
    location /api/events {
        proxy_pass http://tg_api:3000/api/events;
        proxy_http_version 1.1;
        
        # ä»£ç†å¤´è®¾ç½®
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # SSE ä¸“ç”¨è®¾ç½®
        proxy_set_header Connection '';
        proxy_set_header Cache-Control 'no-cache';
        
        # ç¦ç”¨ç¼“å†²ï¼ˆSSE å¿…éœ€ï¼‰
        proxy_buffering off;
        proxy_cache off;
        
        # å¢åŠ è¶…æ—¶æ—¶é—´ï¼ˆSSE é•¿è¿æ¥éœ€è¦ï¼‰
        proxy_connect_timeout 300s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
        
        # ç¦ç”¨ gzip å‹ç¼©ï¼ˆSSE ä¸èƒ½å‹ç¼©ï¼‰
        gzip off;
        
        # ç¦ç”¨å…¶ä»–å¯èƒ½å½±å“ SSE çš„è®¾ç½®
        chunked_transfer_encoding on;
        
        # æ·»åŠ  CORS å¤´ï¼ˆå¦‚æœéœ€è¦ï¼‰
        add_header Access-Control-Allow-Origin $http_origin always;
        add_header Access-Control-Allow-Credentials true always;
        add_header Access-Control-Allow-Methods 'GET, OPTIONS' always;
        add_header Access-Control-Allow-Headers 'Authorization, Content-Type' always;
        
        # å¤„ç† OPTIONS é¢„æ£€è¯·æ±‚
        if ($request_method = 'OPTIONS') {
            add_header Access-Control-Allow-Origin $http_origin always;
            add_header Access-Control-Allow-Credentials true always;
            add_header Access-Control-Allow-Methods 'GET, OPTIONS' always;
            add_header Access-Control-Allow-Headers 'Authorization, Content-Type' always;
            add_header Access-Control-Max-Age 1728000;
            add_header Content-Type 'text/plain charset=UTF-8';
            add_header Content-Length 0;
            return 204;
        }
    }

    # ğŸ”’ ç¦æ­¢å¤–éƒ¨è®¿é—®å†…éƒ¨æ¥å£ï¼ˆå†…éƒ¨æœåŠ¡é€šè¿‡ Docker ç½‘ç»œç›´è¿ api:3000ï¼‰
    location ^~ /api/internal/ {
        return 404;
    }
    
    # API ä»£ç†ï¼ˆé€šç”¨é…ç½®ï¼‰
    location /api/ {
        proxy_pass http://tg_api:3000/api/;
        proxy_http_version 1.1;
        
        # ä»£ç†å¤´è®¾ç½®
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # WebSocket æ”¯æŒï¼ˆå¦‚æœéœ€è¦ï¼‰
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # è¶…æ—¶è®¾ç½®
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        
        # ç¼“å†²è®¾ç½®
        proxy_buffering off;
        
        # CORS å¤´ï¼ˆå¦‚æœéœ€è¦ï¼Œåç«¯å·²ç»å¤„ç†ï¼Œè¿™é‡Œä½œä¸ºå¤‡ç”¨ï¼‰
        add_header Access-Control-Allow-Origin $http_origin always;
        add_header Access-Control-Allow-Credentials true always;
        add_header Access-Control-Allow-Methods 'GET, POST, PUT, DELETE, OPTIONS' always;
        add_header Access-Control-Allow-Headers 'Authorization, Content-Type, X-Requested-With' always;
        
        # å¤„ç† OPTIONS é¢„æ£€è¯·æ±‚
        if ($request_method = 'OPTIONS') {
            add_header Access-Control-Allow-Origin $http_origin always;
            add_header Access-Control-Allow-Credentials true always;
            add_header Access-Control-Allow-Methods 'GET, POST, PUT, DELETE, OPTIONS' always;
            add_header Access-Control-Allow-Headers 'Authorization, Content-Type, X-Requested-With' always;
            add_header Access-Control-Max-Age 1728000;
            add_header Content-Type 'text/plain charset=UTF-8';
            add_header Content-Length 0;
            return 204;
        }
    }
    
    # å¥åº·æ£€æŸ¥
    location /health {
        proxy_pass http://tg_api:3000/health;
        access_log off;
    }
    
    # Gzip å‹ç¼©
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml+rss application/json;
    
    # å®‰å…¨å¤´
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
}
